<!-- build time:Tue Feb 16 2021 19:55:26 GMT+0800 (China Standard Time) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 4.2.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:new URL("https://www.lmikoto.com").hostname,root:"/",scheme:"Pisces",version:"7.7.0",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!1,show_result:!1,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!1},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{appID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},path:"search.xml",motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}}}</script><meta name="description" content="activiti 的配置类是org.activiti.engine.ProcessEngines,本文主要讨论他的默认实现getDefaultProcessEngine123456public static ProcessEngine getProcessEngine(String processEngineName) &amp;#123;  if (!isInitialized()) &amp;#123;"><meta property="og:type" content="article"><meta property="og:title" content="Activiti7源码分析(三)-流程引擎配置类"><meta property="og:url" content="https://www.lmikoto.com/2020/09/29/Activiti7%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(%E4%B8%89)-%E6%B5%81%E7%A8%8B%E5%BC%95%E6%93%8E%E9%85%8D%E7%BD%AE%E7%B1%BB/index.html"><meta property="og:site_name" content="Lmikoto"><meta property="og:description" content="activiti 的配置类是org.activiti.engine.ProcessEngines,本文主要讨论他的默认实现getDefaultProcessEngine123456public static ProcessEngine getProcessEngine(String processEngineName) &amp;#123;  if (!isInitialized()) &amp;#123;"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2020-09-29T14:05:44.000Z"><meta property="article:modified_time" content="2021-02-16T11:55:17.422Z"><meta property="article:author" content="lmikoto"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://www.lmikoto.com/2020/09/29/Activiti7%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(%E4%B8%89)-%E6%B5%81%E7%A8%8B%E5%BC%95%E6%93%8E%E9%85%8D%E7%BD%AE%E7%B1%BB/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0}</script><title>Activiti7源码分析(三)-流程引擎配置类 | Lmikoto</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript><link rel="alternate" href="/atom.xml" title="Lmikoto" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-meta"><div><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">Lmikoto</span> <span class="logo-line-after"><i></i></span></a></div></div><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a></li><li class="menu-item menu-item-tools"><a href="https://t.lmikoto.com/" rel="noopener" target="_blank"><i class="fa fa-fw fa-calendar"></i>工具</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="site-search"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="搜索..." spellcheck="false" type="text" id="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"></div></div><div class="search-pop-overlay"></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content"><div class="posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.lmikoto.com/2020/09/29/Activiti7%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(%E4%B8%89)-%E6%B5%81%E7%A8%8B%E5%BC%95%E6%93%8E%E9%85%8D%E7%BD%AE%E7%B1%BB/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="lmikoto"><meta itemprop="description" content=""></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Lmikoto"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Activiti7源码分析(三)-流程引擎配置类</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-09-29 22:05:44" itemprop="dateCreated datePublished" datetime="2020-09-29T22:05:44+08:00">2020-09-29</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2021-02-16 19:55:17" itemprop="dateModified" datetime="2021-02-16T19:55:17+08:00">2021-02-16</time> </span><span id="/2020/09/29/Activiti7%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(%E4%B8%89)-%E6%B5%81%E7%A8%8B%E5%BC%95%E6%93%8E%E9%85%8D%E7%BD%AE%E7%B1%BB/" class="post-meta-item leancloud_visitors" data-flag-title="Activiti7源码分析(三)-流程引擎配置类" title="阅读次数"><span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span class="leancloud-visitors-count"></span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-comment-o"></i> </span><span class="post-meta-item-text">Valine：</span> <a title="valine" href="/2020/09/29/Activiti7%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(%E4%B8%89)-%E6%B5%81%E7%A8%8B%E5%BC%95%E6%93%8E%E9%85%8D%E7%BD%AE%E7%B1%BB/#comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/2020/09/29/Activiti7%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(%E4%B8%89)-%E6%B5%81%E7%A8%8B%E5%BC%95%E6%93%8E%E9%85%8D%E7%BD%AE%E7%B1%BB/" itemprop="commentCount"></span></a></span></div></header><div class="post-body" itemprop="articleBody"><p>activiti 的配置类是<code>org.activiti.engine.ProcessEngines</code>,本文主要讨论他的默认实现<code>getDefaultProcessEngine</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ProcessEngine <span class="title">getProcessEngine</span><span class="params">(String processEngineName)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!isInitialized()) &#123;</span><br><span class="line">    init();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> processEngines.get(processEngineName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>首先，他会传进去一个 default 的字符串。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ProcessEngine <span class="title">getProcessEngine</span><span class="params">(String processEngineName)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!isInitialized()) &#123;</span><br><span class="line">    init();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> processEngines.get(processEngineName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>如果没有初始化，走初始化的逻辑</li><li>返回 processEngines map 中的配配置，processEngineName 就是上面传过来的 default</li></ul><p>然后再来看 init 方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">```java</span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>这个方法是个同步方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!isInitialized()) &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里又判断了一次是否初始化，可能有的人觉得这步判断有些多余，因为进入这个方法之前已经判断过了，但是在并发场景下并不多余，两个请求都没有初始化过流程引擎，同时走到 init 方法，然后其中一个先执行，另一个等待。一个执行完毕之后，另一个进来，发现已经初始化完成了，就不需要再执行了。<br>然后，获取 activiti 的配置文件 activiti.cfg，进行初始化,代码如下。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">ClassLoader classLoader = ReflectUtil.getClassLoader();</span><br><span class="line">Enumeration&lt;URL&gt; resources = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  resources = classLoader.getResources(<span class="string">"activiti.cfg.xml"</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> ActivitiIllegalArgumentException(<span class="string">"problem retrieving activiti.cfg.xml resources on the classpath: "</span> + System.getProperty(<span class="string">"java.class.path"</span>), e);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Remove duplicated configuration URL's using set. Some</span></span><br><span class="line"><span class="comment">// classloaders may return identical URL's twice, causing duplicate</span></span><br><span class="line"><span class="comment">// startups</span></span><br><span class="line">Set&lt;URL&gt; configUrls = <span class="keyword">new</span> HashSet&lt;URL&gt;();</span><br><span class="line"><span class="keyword">while</span> (resources.hasMoreElements()) &#123;</span><br><span class="line">  configUrls.add(resources.nextElement());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (Iterator&lt;URL&gt; iterator = configUrls.iterator(); iterator.hasNext();) &#123;</span><br><span class="line">  URL resource = iterator.next();</span><br><span class="line">  log.info(<span class="string">"Initializing process engine using configuration '&#123;&#125;'"</span>, resource.toString());</span><br><span class="line">  initProcessEngineFromResource(resource);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>首先去获取了一个 ClassLoader，这个 ClassLoader 可以使用默认自带的，也可以使用自定制的。都没问题。然后获取一下配置文件的的位置。对这些位置去重。然后遍历这些 url，进行初始化资源。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ProcessEngineInfo processEngineInfo = processEngineInfosByResourceUrl.get(resourceUrl.toString());</span><br><span class="line"><span class="comment">// if there is an existing process engine info</span></span><br><span class="line"><span class="keyword">if</span> (processEngineInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">  <span class="comment">// remove that process engine from the member fields</span></span><br><span class="line">  processEngineInfos.remove(processEngineInfo);</span><br><span class="line">  <span class="keyword">if</span> (processEngineInfo.getException() == <span class="keyword">null</span>) &#123;</span><br><span class="line">    String processEngineName = processEngineInfo.getName();</span><br><span class="line">    processEngines.remove(processEngineName);</span><br><span class="line">    processEngineInfosByName.remove(processEngineName);</span><br><span class="line">  &#125;</span><br><span class="line">  processEngineInfosByResourceUrl.remove(processEngineInfo.getResourceUrl());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里上来也做了个一个类似去重的操作，因为初始化的过程中可能会失败，会走如 retry 方法，这里保证每一个 url 对应的配置信息只有最后加载的那一个。<br>再来看一下构建流程引擎的方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> ProcessEngine <span class="title">buildProcessEngine</span><span class="params">(URL resource)</span> </span>&#123;</span><br><span class="line">    InputStream inputStream = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      inputStream = resource.openStream();</span><br><span class="line">      ProcessEngineConfiguration processEngineConfiguration = ProcessEngineConfiguration.createProcessEngineConfigurationFromInputStream(inputStream);</span><br><span class="line">      <span class="keyword">return</span> processEngineConfiguration.buildProcessEngine();</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ActivitiIllegalArgumentException(<span class="string">"couldn't open resource stream: "</span> + e.getMessage(), e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      IoUtil.closeSilently(inputStream);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用 url 构建 输入流。然后传入 createProcessEngineConfigurationFromInputStream 方法。再来看一下这个方法,然后依次往下找。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ProcessEngineConfiguration <span class="title">parseProcessEngineConfiguration</span><span class="params">(Resource springResource, String beanName)</span> </span>&#123;</span><br><span class="line">    DefaultListableBeanFactory beanFactory = <span class="keyword">new</span> DefaultListableBeanFactory();</span><br><span class="line">    XmlBeanDefinitionReader xmlBeanDefinitionReader = <span class="keyword">new</span> XmlBeanDefinitionReader(beanFactory);</span><br><span class="line">    xmlBeanDefinitionReader.setValidationMode(XmlBeanDefinitionReader.VALIDATION_XSD);</span><br><span class="line">    xmlBeanDefinitionReader.loadBeanDefinitions(springResource);</span><br><span class="line">    ProcessEngineConfigurationImpl processEngineConfiguration = (ProcessEngineConfigurationImpl) beanFactory.getBean(beanName);</span><br><span class="line">    processEngineConfiguration.setBeans(<span class="keyword">new</span> SpringBeanFactoryProxyMap(beanFactory));</span><br><span class="line">    <span class="keyword">return</span> processEngineConfiguration;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里的 beanname 是 processEngineConfiguration，这里省略了中间步骤。<br>这里是使用了 spring 的方法，把 xml 的配置转换成 bean。<br>然后回到 buildProcessEngine</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ProcessEngine <span class="title">buildProcessEngine</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  init();</span><br><span class="line">  ProcessEngineImpl processEngine = <span class="keyword">new</span> ProcessEngineImpl(<span class="keyword">this</span>);</span><br><span class="line">  postProcessEngineInitialisation();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> processEngine;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里也很好懂。<br>调用 init 方法，这个 init 方法就是上一篇中的那个 init。在这里初始化了 activiti 的资源，包括上篇提到的命令执行器，和职责链，各种 service</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">initConfigurators();</span><br><span class="line">configuratorsBeforeInit();</span><br><span class="line">initHistoryLevel();</span><br><span class="line">initExpressionManager();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (usingRelationalDatabase) &#123;</span><br><span class="line">  initDataSource();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">initAgendaFactory();</span><br><span class="line">initHelpers();</span><br><span class="line">initVariableTypes();</span><br><span class="line">initBeans();</span><br><span class="line">initScriptingEngines();</span><br><span class="line">initClock();</span><br><span class="line">initBusinessCalendarManager();</span><br><span class="line">initCommandContextFactory();</span><br><span class="line">initTransactionContextFactory();</span><br><span class="line">initCommandExecutors();</span><br><span class="line">initServices();</span><br><span class="line">initIdGenerator();</span><br><span class="line">initBehaviorFactory();</span><br><span class="line">initListenerFactory();</span><br><span class="line">initBpmnParser();</span><br><span class="line">initProcessDefinitionCache();</span><br><span class="line">initProcessDefinitionInfoCache();</span><br><span class="line">initKnowledgeBaseCache();</span><br><span class="line">initJobHandlers();</span><br><span class="line">initJobManager();</span><br><span class="line">initAsyncExecutor();</span><br><span class="line"></span><br><span class="line">initTransactionFactory();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (usingRelationalDatabase) &#123;</span><br><span class="line">  initSqlSessionFactory();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">initSessionFactories();</span><br><span class="line">initDataManagers();</span><br><span class="line">initEntityManagers();</span><br><span class="line">initHistoryManager();</span><br><span class="line">initJpa();</span><br><span class="line">initDeployers();</span><br><span class="line">initDelegateInterceptor();</span><br><span class="line">initEventHandlers();</span><br><span class="line">initFailedJobCommandFactory();</span><br><span class="line">initEventDispatcher();</span><br><span class="line">initProcessValidator();</span><br><span class="line">initDatabaseEventLogging();</span><br><span class="line">configuratorsAfterInit();</span><br></pre></td></tr></table></figure><p>里面一些比较重要的，后面会进行讨论，这里就不进行展开了。<br>回到之前方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  resources = classLoader.getResources(<span class="string">"activiti-context.xml"</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> ActivitiIllegalArgumentException(<span class="string">"problem retrieving activiti-context.xml resources on the classpath: "</span> + System.getProperty(<span class="string">"java.class.path"</span>), e);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">while</span> (resources.hasMoreElements()) &#123;</span><br><span class="line">  URL resource = resources.nextElement();</span><br><span class="line">  log.info(<span class="string">"Initializing process engine using Spring configuration '&#123;&#125;'"</span>, resource.toString());</span><br><span class="line">  initProcessEngineFromSpringResource(resource);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>activiti 也支持 Spring 风格的初始化。这里获取了 activiti-context.xml，然后调用 initProcessEngineFromSpringResource 初始化资源。<br>来看一下 initProcessEngineFromSpringResource</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    Class&lt;?&gt; springConfigurationHelperClass = ReflectUtil.loadClass(<span class="string">"org.activiti.spring.SpringConfigurationHelper"</span>);</span><br><span class="line">    Method method = springConfigurationHelperClass.getDeclaredMethod(<span class="string">"buildProcessEngine"</span>, <span class="keyword">new</span> Class&lt;?&gt;[] &#123; URL<span class="class">.<span class="keyword">class</span> &#125;)</span>;</span><br><span class="line">    ProcessEngine processEngine = (ProcessEngine) method.invoke(<span class="keyword">null</span>, <span class="keyword">new</span> Object[] &#123; resource &#125;);</span><br><span class="line"></span><br><span class="line">    String processEngineName = processEngine.getName();</span><br><span class="line">    ProcessEngineInfo processEngineInfo = <span class="keyword">new</span> ProcessEngineInfoImpl(processEngineName, resource.toString(), <span class="keyword">null</span>);</span><br><span class="line">    processEngineInfosByName.put(processEngineName, processEngineInfo);</span><br><span class="line">    processEngineInfosByResourceUrl.put(resource.toString(), processEngineInfo);</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> ActivitiException(<span class="string">"couldn't initialize process engine from spring configuration resource "</span> + resource.toString() + <span class="string">": "</span> + e.getMessage(), e);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>通过反射调用 SpringConfigurationHelper 的 buildProcessEngine 方法。来看一下这个方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ProcessEngine <span class="title">buildProcessEngine</span><span class="params">(URL resource)</span> </span>&#123;</span><br><span class="line">  log.debug(<span class="string">"==== BUILDING SPRING APPLICATION CONTEXT AND PROCESS ENGINE ========================================="</span>);</span><br><span class="line"></span><br><span class="line">  ApplicationContext applicationContext = <span class="keyword">new</span> GenericXmlApplicationContext(<span class="keyword">new</span> UrlResource(resource));</span><br><span class="line">  Map&lt;String, ProcessEngine&gt; beansOfType = applicationContext.getBeansOfType(ProcessEngine<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">  <span class="keyword">if</span> ((beansOfType == <span class="keyword">null</span>) || (beansOfType.isEmpty())) &#123;</span><br><span class="line">    throw new ActivitiException("no " + ProcessEngine.class.getName() + " defined in the application context " + resource.toString());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ProcessEngine processEngine = beansOfType.values().iterator().next();</span><br><span class="line"></span><br><span class="line">  log.debug(<span class="string">"==== SPRING PROCESS ENGINE CREATED =================================================================="</span>);</span><br><span class="line">  <span class="keyword">return</span> processEngine;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>好的。activiti 的配置类分析到此就结束了。<br>简单总结一下，activiti 配置类主要的工作就是做一些配置的初始化工作，支持 activiti 风格的配置和 spring 风格的配置。</p></div><footer class="post-footer"><div class="post-nav"><div class="post-nav-item"><a href="/2020/09/29/Activiti7%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(%E4%BA%8C)-Service%E8%B0%83%E7%94%A8%E9%93%BE%E8%B7%AF/" rel="prev" title="Activiti7源码分析(二)-Service调用链路"><i class="fa fa-chevron-left"></i> Activiti7源码分析(二)-Service调用链路</a></div><div class="post-nav-item"><a href="/2020/09/29/Activiti7%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(%E5%9B%9B)-id%E7%94%9F%E6%88%90%E5%99%A8/" rel="next" title="Activiti7源码分析(四)-id生成器">Activiti7源码分析(四)-id生成器 <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div><div class="comments" id="valine-comments"></div><script>window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="post-toc-wrap sidebar-panel"></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><p class="site-author-name" itemprop="name">lmikoto</p><div class="site-description" itemprop="description"></div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">40</span> <span class="site-state-item-name">日志</span></a></div></nav></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2021</span> <span class="with-love"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">lmikoto</span></div><div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v4.2.0</div><span class="post-meta-divider">|</span><div class="theme-info">主题 – <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.7.0</div></div></footer></div><script src="/lib/anime.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script src="/js/local-search.js"></script><script>NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el: '#valine-comments',
      verify: false,
      notify: false,
      appId: 'u8TpIriGw2IpKOJiW90prUon-gzGzoHsz',
      appKey: 'yxGPeSkeRi6Xj1sOXbIpazgK',
      placeholder: "Just go go",
      avatar: 'mm',
      meta: guest,
      pageSize: '10' || 10,
      visitor: true,
      lang: '' || 'zh-cn',
      path: location.pathname,
      recordIP: false,
      serverURLs: ''
    });
  }, window.Valine);
});</script></body></html><!-- rebuild by neat -->